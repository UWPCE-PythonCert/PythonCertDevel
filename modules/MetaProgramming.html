

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Metaprogramming &mdash; PythonCert 4.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="PythonCert 4.0 documentation" href="../index.html"/>
        <link rel="up" title="Modules" href="index.html"/>
        <link rel="next" title="Asychronous Programing" href="Async.html"/>
        <link rel="prev" title="Debugging" href="Debugging.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> PythonCert
          

          
          </a>

          
            
            
              <div class="version">
                4.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#first-class-introduction-to-python">First Class: Introduction to Python</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#second-class-advanced-python">Second Class: Advanced Python</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="IteratorsAndGenerators.html">Iterators and Generators</a></li>
<li class="toctree-l3"><a class="reference internal" href="Packaging.html">Packages and Packaging</a></li>
<li class="toctree-l3"><a class="reference internal" href="CodeReviews.html">Code Reviews</a></li>
<li class="toctree-l3"><a class="reference internal" href="Closures.html">Closures and Function Currying</a></li>
<li class="toctree-l3"><a class="reference internal" href="Decorators.html">Decorators</a></li>
<li class="toctree-l3"><a class="reference internal" href="ContextManagers.html">Context Managers</a></li>
<li class="toctree-l3"><a class="reference internal" href="Pep8.html">Coding Style and Linting</a></li>
<li class="toctree-l3"><a class="reference internal" href="Testing_advanced.html">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="Logging.html">Logging and the logging module</a></li>
<li class="toctree-l3"><a class="reference internal" href="Debugging.html">Debugging</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Metaprogramming</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">Metaprogramming</a></li>
<li class="toctree-l4"><a class="reference internal" href="#introspeciton-and-manipulation-tools">Introspeciton and manipulation tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="#metaclasses">metaclasses</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="Async.html">Asychronous Programing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../exercises/index.html">Exercises</a></li>
<li class="toctree-l1"><a class="reference internal" href="../supplemental/index.html">Supplemental Materials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/index.html">Resources for Specific Python Topics</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PythonCert</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Modules</a> &raquo;</li>
        
      <li>Metaprogramming</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/modules/MetaProgramming.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="metaprogramming">
<span id="id1"></span><h1>Metaprogramming<a class="headerlink" href="#metaprogramming" title="Permalink to this headline">¶</a></h1>
<p>NOTE: These notes are due for an updated – stay tuned!</p>
<p>programs that write programs….</p>
<div class="section" id="id2">
<h2>Metaprogramming<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p class="left"><strong>Metaprogramming:</strong></p>
<p class="left">“Metaprogramming is a programming technique in which computer programs have the ability to treat programs as their data. It means that a program can be designed to read, generate, analyse or transform other programs, and even modify itself while running.”</p>
<p class="left">– <code class="docutils literal"><span class="pre">https://en.wikipedia.org/wiki/Metaprogramming</span></code></p>
<p class="left">In other words: A metaprogram is a program that writes (or maodifies) programs.</p>
<p class="left">As a dynamic language, Python is very well suited to metaprograming, as it allows objects to be modified at run time. It also provides excellent tools for <strong>“Introspection”</strong>:</p>
<p class="left">“The ability of a program to examine the type or properties of an object at runtime.”</p>
<div class="section" id="a-class-is-just-an-object">
<h3>A class is just an object<a class="headerlink" href="#a-class-is-just-an-object" title="Permalink to this headline">¶</a></h3>
<p>A class is a first-class object:</p>
<p>Can be created at runtime</p>
<p>Passed as a parameter</p>
<p>Returned from a function</p>
<p>Assigned to a variable</p>
<p>(sound familiar from when we were talking about functions?)</p>
<p>This “everything is an object” is what allows full introspection and metaprogramming.</p>
</div>
</div>
<div class="section" id="introspeciton-and-manipulation-tools">
<h2>Introspeciton and manipulation tools<a class="headerlink" href="#introspeciton-and-manipulation-tools" title="Permalink to this headline">¶</a></h2>
<div class="section" id="getattr-and-setattr">
<h3><code class="docutils literal"><span class="pre">getattr()</span></code> and <code class="docutils literal"><span class="pre">setattr()</span></code><a class="headerlink" href="#getattr-and-setattr" title="Permalink to this headline">¶</a></h3>
<p>these allow you to get and set attributes of an object by name:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="k">class</span> <span class="nc">Dummy</span><span class="p">():</span>
<span class="gp">   ...: </span>    <span class="sd">&quot;&quot;&quot;A class with nothing in it&quot;&quot;&quot;</span>
<span class="gp">   ...: </span>    <span class="k">pass</span>
<span class="gp">   ...:</span>

<span class="gp">In [2]: </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>

<span class="gp">In [3]: </span><span class="nb">vars</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="gh">Out[3]: </span><span class="go">{}</span>

<span class="gp">In [4]: </span><span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="mi">54</span><span class="p">)</span>

<span class="gp">In [5]: </span><span class="nb">vars</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="gh">Out[5]: </span><span class="go">{&#39;this&#39;: 54}</span>

<span class="gp">In [6]: </span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">)</span>
<span class="gh">Out[6]: </span><span class="go">54</span>
</pre></div>
</div>
<p>Let’s play with this: (demo)</p>
<p>NOTE: Do attributes have to be python legal python names??</p>
</div>
<div class="section" id="what-s-in-a-class">
<h3>What’s in a Class?<a class="headerlink" href="#what-s-in-a-class" title="Permalink to this headline">¶</a></h3>
<p>A class (and instance) object stores its attributes in a dictionary – yes, a regular old python dict. You can access that dict with the <code class="docutils literal"><span class="pre">__dict__</span></code> attribute:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [11]: </span><span class="k">class</span> <span class="nc">Simple</span><span class="p">():</span>
<span class="go">    ...:     this = &quot;a class attribute&quot;</span>
<span class="go">    ...:     def __init__(self):</span>
<span class="go">    ...:         self.that = &quot;an instance attribute&quot;</span>
<span class="go">    ...:</span>

<span class="gp">In [12]: </span><span class="n">obj</span> <span class="o">=</span> <span class="n">Simple</span><span class="p">()</span>

<span class="gp">In [13]: </span><span class="n">Simple</span><span class="o">.</span><span class="vm">__dict__</span>
<span class="gh">Out[13]:</span>
<span class="go">mappingproxy({&#39;__dict__&#39;: &lt;attribute &#39;__dict__&#39; of &#39;Simple&#39; objects&gt;,</span>
<span class="go">              &#39;__doc__&#39;: None,</span>
<span class="go">              &#39;__init__&#39;: &lt;function __main__.Simple.__init__&gt;,</span>
<span class="go">              &#39;__module__&#39;: &#39;__main__&#39;,</span>
<span class="go">              &#39;__weakref__&#39;: &lt;attribute &#39;__weakref__&#39; of &#39;Simple&#39; objects&gt;,</span>
<span class="go">              &#39;this&#39;: &#39;a class attribute&#39;})</span>

<span class="gp">In [15]: </span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span>
<span class="gh">Out[15]: </span><span class="go">{&#39;that&#39;: &#39;an instance attribute&#39;}</span>
</pre></div>
</div>
</div>
<div class="section" id="what-class-does-this-object-belong-to">
<h3>What class does this object belong to?<a class="headerlink" href="#what-class-does-this-object-belong-to" title="Permalink to this headline">¶</a></h3>
<p>every object has a <code class="docutils literal"><span class="pre">__class__</span></code> attribute specifying what class the object belongs to:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [16]: </span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span>
<span class="gh">Out[16]: </span><span class="go">__main__.Simple</span>
</pre></div>
</div>
<p>and that is the actuall class object:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [17]: </span><span class="n">obj</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">is</span> <span class="n">Simple</span>
<span class="gh">Out[17]: </span><span class="go">True</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="metaclasses">
<h2>metaclasses<a class="headerlink" href="#metaclasses" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-a-class-from-scratch">
<h3>Creating a class from scratch<a class="headerlink" href="#creating-a-class-from-scratch" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">create_a_class</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>
<span class="gp">... </span>   <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;CoolClass&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="nb">dict</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cool_class</span> <span class="o">=</span> <span class="n">create_a_class</span><span class="p">(</span><span class="n">foo</span><span class="o">=</span><span class="s1">&#39;nice&#39;</span><span class="p">,</span> <span class="n">bar</span><span class="o">=</span><span class="s1">&#39;sweet&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cool_class</span>
<span class="go">&lt;class &#39;__main__.CoolClass&#39;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cool_object</span> <span class="o">=</span> <span class="n">cool_class</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cool_object</span>
<span class="go">&lt;__main__.CoolClass object at 0x10224e208&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cool_object</span><span class="o">.</span><span class="n">foo</span>
<span class="go">&#39;nice&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cool_object</span><span class="o">.</span><span class="n">bar</span>
<span class="go">&#39;sweet&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="equivalent-to">
<h3>Equivalent to:<a class="headerlink" href="#equivalent-to" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CoolClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="n">foo</span> <span class="o">=</span> <span class="s1">&#39;nice&#39;</span>
   <span class="n">bar</span> <span class="o">=</span> <span class="s1">&#39;sweet&#39;</span>
</pre></div>
</div>
<p>But it was created at runtime, returned from a function and assigned to a variable.</p>
<p><a class="reference external" href="http://eli.thegreenplace.net/2011/08/14/python-metaclasses-by-example">http://eli.thegreenplace.net/2011/08/14/python-metaclasses-by-example</a></p>
</div>
<div class="section" id="type-or-class">
<h3>“type” or “class”<a class="headerlink" href="#type-or-class" title="Permalink to this headline">¶</a></h3>
<p>We talk about “classes”, and yet we create them with <code class="docutils literal"><span class="pre">type()</span></code>.</p>
<p>In python, “type” and “class” are essentially the same thing.</p>
<p>So why the two names?</p>
<p>History: in teheraly days of python, a “type” was a built-in object, and a “class” was an object crated with code.</p>
<p>type - class unifiation began in python 2.2:</p>
<p><code class="docutils literal"><span class="pre">https://www.python.org/download/releases/2.2/descrintro/</span></code></p>
<p>In python3, the unification is complete – types <em>are</em> classes and vice-versa.</p>
</div>
<div class="section" id="more-on-classes">
<h3>More on Classes<a class="headerlink" href="#more-on-classes" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Objects get created from classes. So what is the class of a class?</p>
<p>The class of a Class is a metaclass</p>
<p>The metaclass can be used to dynamically create a class</p>
<p>The metaclass, being a class, also has a metaclass</p>
</div></blockquote>
</div>
<div class="section" id="what-is-a-metaclass">
<h3>What is a metaclass?<a class="headerlink" href="#what-is-a-metaclass" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>A class is something that makes instances</li>
<li>A metaclass is something that makes classes</li>
<li>A metaclass is most commonly used as a class factory</li>
<li>Metaclasses allow you to do ‘extra things’ when creating a class,
like registering the new class with some registry, adding methods
dynamically, or even replace the class with something else entirely</li>
<li>Every object in Python has a metaclass</li>
<li>The default metaclass is <code class="docutils literal"><span class="pre">type()</span></code></li>
</ul>
</div>
<div class="section" id="type">
<h3><code class="docutils literal"><span class="pre">type()</span></code><a class="headerlink" href="#type" title="Permalink to this headline">¶</a></h3>
<p>With one argument, <code class="docutils literal"><span class="pre">type()</span></code> returns the type of the argument</p>
<p>With 3 arguments, <code class="docutils literal"><span class="pre">type()</span></code> returns a new class</p>
<div class="highlight-ipython"><div class="highlight"><pre><span></span>type<span class="o">?</span>
<span class="n">Type</span><span class="p">:</span>       <span class="nb">type</span>
<span class="n">String</span> <span class="n">Form</span><span class="p">:</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">&#39;type&#39;</span><span class="o">&gt;</span>
<span class="n">Namespace</span><span class="p">:</span>  <span class="n">Python</span> <span class="n">builtin</span>
<span class="n">Docstring</span><span class="p">:</span>
<span class="nb">type</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">the</span> <span class="nb">object</span><span class="s1">&#39;s type</span>
<span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="n">new</span> <span class="nb">type</span>

<span class="n">name</span><span class="p">:</span> <span class="n">string</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="k">class</span>
<span class="nc">bases</span><span class="p">:</span> <span class="nb">tuple</span> <span class="n">of</span> <span class="n">the</span> <span class="n">parent</span> <span class="n">classes</span>
<span class="nb">dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="n">containing</span> <span class="n">attribute</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">values</span>
</pre></div>
</div>
</div>
<div class="section" id="using-type-to-build-a-class">
<h3>using type() to build a class<a class="headerlink" href="#using-type-to-build-a-class" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">class</span></code> keyword is syntactic sugar, we can get by without it by
using type</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">MyClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;MyClass&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
<p>(<code class="docutils literal"><span class="pre">object</span></code> is automatically a superclass)</p>
</div>
<div class="section" id="adding-methods-to-a-class-built-with-type">
<h3>Adding methods to a class built with <code class="docutils literal"><span class="pre">type()</span></code><a class="headerlink" href="#adding-methods-to-a-class-built-with-type" title="Permalink to this headline">¶</a></h3>
<p>Just define a function with the correct signature and add it to the attr
dictionary</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;called my_method, x = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">MyClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s1">&#39;MyClass&#39;</span><span class="p">,(),</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;my_method&#39;</span><span class="p">:</span> <span class="n">my_method</span><span class="p">})</span>
<span class="n">o</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
<span class="n">o</span><span class="o">.</span><span class="n">my_method</span><span class="p">()</span>
</pre></div>
</div>
<p>MyClass = type(name, bases, dct)</p>
<ul class="simple">
<li>name: name of newly created class</li>
<li>bases: tuple of class’s base classes</li>
<li>dct: class attribute mapping</li>
</ul>
</div>
<div class="section" id="what-type-is-type">
<h3>What type is type?<a class="headerlink" href="#what-type-is-type" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython"><div class="highlight"><pre><span></span><span class="gp">In [30]: </span><span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
<span class="gh">Out[30]: </span><span class="go">type</span>
</pre></div>
</div>
</div>
<div class="section" id="metaclass">
<h3><code class="docutils literal"><span class="pre">metaclass</span></code><a class="headerlink" href="#metaclass" title="Permalink to this headline">¶</a></h3>
<p>Setting a class’ metaclass:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MyMetaClass</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>the class assigned to the <code class="docutils literal"><span class="pre">metaclass</span></code> keyword argument will be used to create the object class <code class="docutils literal"><span class="pre">Foo</span></code>.</p>
<p>If the <code class="docutils literal"><span class="pre">metaclass</span></code> kwarg is not defined, it will use type to create the class.</p>
<p>Whatever is assigned to <code class="docutils literal"><span class="pre">metaclass</span></code> should be a callable with the
same signature as type()</p>
<p><strong>Python2 NOTE:</strong></p>
<p>In Python 2, instead of the keyword argument, a special class attribute: <code class="docutils literal"><span class="pre">__metaclass__</span></code> is used:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="vm">__metaclass__</span> <span class="o">=</span> <span class="n">MyMetaClass</span>
</pre></div>
</div>
</div>
<div class="section" id="why-use-metaclasses">
<h3>Why use metaclasses?<a class="headerlink" href="#why-use-metaclasses" title="Permalink to this headline">¶</a></h3>
<p>Useful when creating an API or framework</p>
<p>Whenever you need to manage object creation for one or more classes</p>
<p>For example, see <code class="docutils literal"><span class="pre">Examples/metclasses/singleton.py</span></code></p>
<p>Or consider the Django ORM:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>

<span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bob&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
<span class="k">print</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p>When the Person class is created, it is dynamically modified to
integrate with the database configured backend. Thus, different
configurations will lead to different class definitions. This is
abstracted from the user of the Model class.</p>
<p>Here is the Django Model metaclass:</p>
<p><a class="reference external" href="https://github.com/django/django/blob/master/django/db/models/base.py#L77">https://github.com/django/django/blob/master/django/db/models/base.py#L77</a></p>
</div>
<div class="section" id="new-vs-init-in-metaclasses">
<h3>__new__  vs  __init__ in Metaclasses<a class="headerlink" href="#new-vs-init-in-metaclasses" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">__new__</span></code> is used when you want to control the creation of the class (object)</p>
<p><code class="docutils literal"><span class="pre">__init__</span></code> is used when you want to control the initiation of the class (object)</p>
<p><code class="docutils literal"><span class="pre">__new__</span></code> and <code class="docutils literal"><span class="pre">__init__</span></code> are both called when the module containing the class is imported for the first time.</p>
<p><code class="docutils literal"><span class="pre">__call__</span></code> is used when you want to control how a class (object) is called (instantiation)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CoolMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Creating class&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CoolMeta</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Initializing class&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
  <span class="nb">super</span><span class="p">(</span><span class="n">CoolMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dct</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Meta has been called&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CoolClass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">CoolMeta</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;And now my CoolClass exists&#39;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Actually instantiating now&#39;</span><span class="p">)</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">CoolClass</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="metaclass-example">
<h3>Metaclass example<a class="headerlink" href="#metaclass-example" title="Permalink to this headline">¶</a></h3>
<p>Consider wanting a metaclass which mangles all attribute names to
provide uppercase and lower case attributes</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">NameMangler</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="namemangler">
<h3>NameMangler<a class="headerlink" href="#namemangler" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NameMangler</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">_dict</span><span class="p">):</span>
        <span class="n">uppercase_attr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">):</span>
                <span class="n">uppercase_attr</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">uppercase_attr</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uppercase_attr</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">clsname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">uppercase_attr</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">NameMangler</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="section" id="exercise-working-with-namemangler">
<h3>Exercise: Working with NameMangler<a class="headerlink" href="#exercise-working-with-namemangler" title="Permalink to this headline">¶</a></h3>
<p>In the repository, find and run <code class="docutils literal"><span class="pre">Examples/metaclasses/mangler.py</span></code></p>
<p>Modify the NameMangler metaclass such that setting an attribute f.x also
sets f.xx</p>
<p>Now create a new metaclass, MangledSingleton, composed of the
NameMangler and Singleton classes in the <code class="docutils literal"><span class="pre">Examples/metaclasses</span></code> directory.</p>
<p>Assign it to the <code class="docutils literal"><span class="pre">metaclass</span></code> keyword argument of a new class and verify that it works.</p>
<p>Your code should look like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">MangledSingleton</span><span class="p">)</span> <span class="c1"># define this</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">o1</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
<span class="n">o2</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">o1</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="n">o1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">o2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-singleton">
<h3>The Singleton<a class="headerlink" href="#the-singleton" title="Permalink to this headline">¶</a></h3>
<p>One common use of metaclasses is to create a singleton. There is an example of this called singleton.py in the Examples directory. However, metaclasses are not the only way to create a singleton. It really depends on what you are trying to do with your singleton.</p>
<p><a class="reference external" href="http://python-3-patterns-idioms-test.readthedocs.io/en/latest/Singleton.html">http://python-3-patterns-idioms-test.readthedocs.io/en/latest/Singleton.html</a></p>
<p><a class="reference external" href="http://stackoverflow.com/questions/6760685/creating-a-singleton-in-python">http://stackoverflow.com/questions/6760685/creating-a-singleton-in-python</a></p>
</div>
<div class="section" id="class-decorators">
<h3>class decorators?<a class="headerlink" href="#class-decorators" title="Permalink to this headline">¶</a></h3>
<p>We touched last week a bit about class decorators:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@a_decorator</span>
<span class="k">class</span> <span class="nc">MyClass</span><span class="p">():</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>A decorator is a “callable” that returns a “callable” – usually a modified
version of he one passed in.</p>
<p>Class objects are callable – you call them when you instantiate a instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">an_inst</span> <span class="o">=</span> <span class="n">MyClass</span><span class="p">()</span>
</pre></div>
</div>
<p>So you can decorate a class as well as functions and methods.</p>
<p>In fact, you can do many of the same things that you can do with metaclasses:</p>
<p>When you decorate a class, you can cahnge it in some way, and then the
changed version replaces the one in the definiton.</p>
<p>This also happens at compile time, rather than run time, just like metaclasses.</p>
<p>class decorators were actually introduced AFTER metaclasses – maybe they
are a clearer solution??</p>
</div>
<div class="section" id="json-save">
<h3>Json_save<a class="headerlink" href="#json-save" title="Permalink to this headline">¶</a></h3>
<p>For a more involved (and useful!) example, see:</p>
<p><code class="docutils literal"><span class="pre">Examples/metaclasses/Json_save</span></code></p>
<p>It is a meta-class based system for saving and re-loading objects.</p>
<p>It works a bit like the ORMs.</p>
<p>It turns out that the metaclass part of the code is pretty simple and small.</p>
<p>But there is a lot of other nifty, magic with classes in there
– so let’s take a look.</p>
</div>
<div class="section" id="reference-reading">
<h3>Reference reading<a class="headerlink" href="#reference-reading" title="Permalink to this headline">¶</a></h3>
<p>About metaclasses (Python 3):</p>
<p class="small"><a class="reference external" href="http://blog.thedigitalcatonline.com/blog/2014/09/01/python-3-oop-part-5-metaclasses">http://blog.thedigitalcatonline.com/blog/2014/09/01/python-3-oop-part-5-metaclasses</a></p>
<p>Python 2 (mostly the same):</p>
<p>What is a metaclass in Python?</p>
<p class="small"><a class="reference external" href="http://stackoverflow.com/a/6581949/747729">http://stackoverflow.com/a/6581949/747729</a></p>
<p>Python metaclasses by example:</p>
<p class="small"><a class="reference external" href="http://eli.thegreenplace.net/2011/08/14/python-metaclasses-by-example/">http://eli.thegreenplace.net/2011/08/14/python-metaclasses-by-example/</a></p>
<p>A Primer on Python Metaclasses:</p>
<p class="small"><a class="reference external" href="http://jakevdp.github.io/blog/2012/12/01/a-primer-on-python-metaclasses/">http://jakevdp.github.io/blog/2012/12/01/a-primer-on-python-metaclasses/</a></p>
<p>And some even more advanced tricks:</p>
<p class="small"><a class="reference external" href="http://blog.thedigitalcatonline.com/blog/2014/10/14/decorators-and-metaclasses">http://blog.thedigitalcatonline.com/blog/2014/10/14/decorators-and-metaclasses</a></p>
</div>
<div class="section" id="notes-on-vars">
<h3>Notes on <code class="docutils literal"><span class="pre">vars</span></code>:<a class="headerlink" href="#notes-on-vars" title="Permalink to this headline">¶</a></h3>
<p>Notes from python-ideas:</p>
<p>“””
I think you may have misunderstood the purpose of vars(). It isn’t to be
a slightly different version of dir(), instead vars() should return the
object’s namespace. Not a copy of the namespace, but the actual
namespace used by the object.</p>
<p>This is how vars() currently works:</p>
<p>py&gt; class X:
…     pass
…
py&gt; obj = X()
py&gt; ns = vars(obj)
py&gt; ns[‘spam’] = 999
py&gt; obj.spam
999</p>
<p>If vars() can return a modified copy of the namespace, that will break
this functionality.</p>
<p>This is not always true, e.g. for classes vars() returns a mappingproxy.</p>
<p>From Doc:</p>
<p>“Objects such as modules and instances have an updateable <code class="docutils literal"><span class="pre">__dict__</span></code> attribute; however, other objects may have write restrictions on their __dict__ attributes (for example, classes use a types.MappingProxyType to prevent direct dictionary updates).”</p>
<p><a class="reference external" href="https://docs.python.org/3.6/library/functions.html#vars">https://docs.python.org/3.6/library/functions.html#vars</a></p>
<p>But you’re right: it’s misleading to return a RW mapping which is a fake namespace…</p>
<p>In the above examples you could just return a <code class="docutils literal"><span class="pre">mappingproxy</span></code>.</p>
<p>If you want to support this feature you could use composition:</p>
<p>This namespace will be updateable, and it let you distinguish between the namespace you want to expose to your clients without compromosing the real one.
Of course, the real one could always be accessible via __dict__ (if present).
“”“</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Async.html" class="btn btn-neutral float-right" title="Asychronous Programing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Debugging.html" class="btn btn-neutral" title="Debugging" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, University of Washington, Christopher Barker, Brian Dorsey, Cris Ewing, Christy Heaton, Jon Jacky, Maria McKinley, Rick Riehle, Joseph Schilz. Creative Commons Attribution-ShareAlike 3.0 license.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'4.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>